import { Tabs, Tab, Callout } from 'nextra/components';

<div className={'shadow-md -ml-2 mt-[30px] mb-[5px] border p-5 rounded '}>
    HTTP status errors with default message, instanceof, stack and nested error cause support.
    Lightweight, typical usage between [400b and 750b](#bundle-size).
    Includes convenience typeguards, optional contextual info and a built-in serializer
    to cover cross-environments challenges (RSC, SSR...).
</div>

<div className="shields-ctn">
    [![npm](https://img.shields.io/npm/v/@httpx/exception?style=for-the-badge&label=Npm&labelColor=444&color=informational)](https://www.npmjs.com/package/@httpx/exception)
    [![changelog](https://img.shields.io/static/v1?label=&message=changelog&logo=github&style=for-the-badge&labelColor=444&color=informational)](https://github.com/belgattitude/httpx/blob/main/packages/exception/CHANGELOG.md)
    [![codecov](https://img.shields.io/codecov/c/github/belgattitude/httpx?logo=codecov&label=Unit&flag=httpx-exception-unit&style=for-the-badge&labelColor=444)](https://app.codecov.io/gh/belgattitude/httpx/tree/main/packages%2Fexception)
    [![bundles](https://img.shields.io/static/v1?label=&message=cjs|esm@treeshake&logo=webpack&style=for-the-badge&labelColor=444&color=informational)](https://github.com/belgattitude/httpx/blob/main/packages/exception/.size-limit.cjs)
    ![node](https://img.shields.io/static/v1?label=Node&message=18%2b&logo=node.js&style=for-the-badge&labelColor=444&color=informational)
    [![browserslist](https://img.shields.io/static/v1?label=Browser&message=%3E93%25&logo=googlechrome&style=for-the-badge&labelColor=444&color=informational)](https://browserslist.dev/?q=ZGVmYXVsdHMsY2hyb21lID49IDk2LGZpcmVmb3ggPj0gOTAsZWRnZSA%2BPSA5MSxzYWZhcmkgPj0gMTUsaW9zID49IDE1LG9wZXJhID49IDc3)
    [![size](https://img.shields.io/bundlephobia/minzip/@httpx/exception@latest?label=Max&style=for-the-badge&labelColor=444&color=informational)](https://bundlephobia.com/package/@httpx/exception@latest)
    [![maintainability](https://img.shields.io/codeclimate/maintainability/belgattitude/httpx?label=Quality&logo=code-climate&style=for-the-badge&labelColor=444)](https://codeclimate.com/github/belgattitude/httpx)
    [![downloads](https://img.shields.io/npm/dm/@httpx/exception?style=for-the-badge&labelColor=444)](https://www.npmjs.com/package/@httpx/exception)
</div>


### Quick start

<Tabs items={['yarn', 'pnpm', 'npm']} defaultIndex={0}>
    <Tab>
        ```bash
        yarn add @httpx/exception
        ```
    </Tab>
    <Tab>
        ```bash
        pnpm add @httpx/exception
        ```
    </Tab>
    <Tab>
        ```bash
        npm install @httpx/exception
        ```
    </Tab>
</Tabs>

### Features

- ðŸ‘‰&nbsp; Usage by [explicit named imports](#by-named-imports) and/or [status code](#by-status-code).
- ðŸ‘‰&nbsp; If message not provided, defaults to [http error message](#default-messages)
- ðŸ‘‰&nbsp; Supports pre-defined [contextual](#error-context) information.
- ðŸ‘‰&nbsp; Built-in [serializer](https://belgattitude.github.io/httpx/#/?id=serializer) to allow cross-env uses (ssr, rsc, superjson, logs...).
- ðŸ‘‰&nbsp; [Extends](https://belgattitude.github.io/httpx/#/?id=uml-class-diagram) native Error class with [stack](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/stack) and [cause](https://belgattitude.github.io/httpx/#/?id=about-errorcause) support.
- ðŸ‘‰&nbsp; Framework agnostic, no deps, browser friendly.


## Usage

### By named imports

Explicit named imports are prefixed by `Http` to ease
IDE experience. Message is optional and default to the [default message](#default-messages). Additional
[parameters](#parameters) are supported.

```typescript
import { HttpNotFound, HttpBadRequest, HttpClientException } from '@httpx/exception';

const e = new HttpNotFound();
// ðŸ‘‰ e.message     -> 'Not found' (default message)
// ðŸ‘‰ e.statusCode  -> 404
// ðŸ‘‰ -> e instanceof HttpClientException

const e400 = new HttpBadRequest('Problems parsing JSON');
// ðŸ‘‰ e.message     -> 'Problems parsing JSON'
// ...
```

### By status code

The `createHttpException` function allows to create an exception from an
arbitrary status code.

```typescript
import { createHttpException } from '@httpx/exception';

const e404 = createHttpException(404); // e404 instanceof HttpClientException
const e500 = createHttpException(500); // e500 instanceof HttpServerException
```

Additional [parameters](#httpexception-parameters) can be provided as a second argument.

```typescript
import { createHttpException, HttpNotImplemented } from "@httpx/exception";

throw createHttpException(404, 'The graal is yet to find !');

const e500 = createHttpException(500, {
  message: 'Something really wrong happened.',
  url: 'https://api.dev/gateway',
  cause: new HttpNotImplemented(), // or any Error...
});
```


## Parameters

Http exceptions and `createHttpException` accept a parameter of type `string | HttpExceptionParams`. If no parameter
is provided the [default message](#default-messages) is used.

### Error context

It's possible to attach informational context to an exception. This is particularly useful when used with
centralized logging / error reporting.

| HttpExceptionParams | Type      | Description                                                                                                                                                           |
| ------------------- | --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| message             | `string?` | [Error.message](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/message), see [about default message](#default-messages). |
| url                 | `string?` | Origin url.                                                                                                                         |
| method              | `HttpMethod?` | Origin http method.                                                                                                                 |
| code                | `string?` | Custom error code (not to be confused with statusCode).                                                                                                                        |
| errorId             | `string?`  | Unique custom error id.                                                                                                                          |
| cause               | `Error?`   | Error.cause, see also [about error cause](#about-errorcause).                                                                                                         |
| issues             | `ValidationIssues[]?` | Only supported by HttpUnprocessableEntity (422)                                                                                    |

Example:

```typescript
import { HttpGatewayTimeout, HttpInternalServerError } from '@httpx/exception';

const e500 = new HttpInternalServerError({
     url: 'https://api.dev/gateway',
     method: 'GET',
     code: 'ERR_UNREACHABLE_SERVICE',
     errorId: nanoid(),
     // ðŸ‘‰ nesting
     cause: new HttpGatewayTimeout({
        message: 'This Serverless Function has timed out',
        errorId: 'cdg1::h99k2-1664884491087-b41a2832f559',
     }),
});
```


## Properties

All parameters are exposed as properties.

| HttpException | Type                 | Description                                                                                                                        |
| ------------- | -------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| statusCode    | `number`             | Http error status code (400-599).                                                                                                  |
| message       | `string`             | Default or provided message.                                                                                                       |
| url           | `string?`            | Origin url..                                                                                      |
| method        | `HttpMethod?`            | Origin http method.                                                                              |
| code          | `string?`            | Custom error code (not to be confused with statusCode).                                                                                     |
| errorId       | `string?`            | Unique custom error id.                                                                                       |
| stack         | `string?`            | @see [Error.prototype.stack](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/Stack) on MDN. |
| cause         | `Error?`             | @see [about error cause](#about-errorcause)                                                                                        |
| issues       | `ValidationIssues[]?` | Only supported by HttpUnprocessableEntity (422)                                                                                    |


```typescript
import { HttpUnprocessableEntity } from '@httpx/exception';

const e422 = new HttpUnprocessableEntity({
   message: 'Request validation failed',
   url: 'https://acme.org/api/user/create',
   method: 'POST',
   issues: [   // typed as ValidationIssues[]
        {
            message: 'Invalid address',
            path: ['addresses', 0, 'line1'],
            code: 'empty_string',
        },
  ]
});

// ðŸ‘‰ e422.issues
// ðŸ‘‰ e422.method === 'POST'
// ...
```

## Static members

All exceptions have a static `STATUS`, this can improve readability and code review.

```typescript
import {createHttpException, HttpMethodNotAllowed } from '@httpx/exception';

const { statusCode } = createHttpException(405);
switch (statusCode) {
    case HttpMethodNotAllowed.STATUS:
       console.log(statusCode); // ðŸ‘‰ 405
       break;
}
```

## Instanceof checks


Http exceptions extends the native [Error class](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)
through HttpException and either HttpServerException and HttpClientException.

```typescript
import { createHttpException } from '@httpx/exception';

const e404 = createHttpException(404);
// ðŸ‘‰ e instanceof Error === true
// ðŸ‘‰ e instanceof HttpException === true
// ðŸ‘‰ e instanceof HttpClientException === true
// ðŸ‘‰ e instanceof HttpNotFound === true
// ðŸ‘‰ e instanceof HttpServerException === false
```

```mermaid
classDiagram
    Error <|-- HttpException
    Error: +string message
    Error: +string? stack
    Error: +unknown cause
    HttpException : +int statusCode
    HttpException : +String url
    HttpException : +Error? cause
    HttpException <|-- HttpClientException
    HttpException <|-- HttpServerException
    HttpClientException <|-- HttpNotFound
    HttpServerException <|-- HttpInternalServerError
    HttpNotFound : 404 statusCode
    HttpInternalServerError: 500 statusCode
```

## Typeguards

```typescript
import {
  isHttpException,
  isHttpClientException,
  isHttpServerException,
  isHttpErrorStatusCode,
} from "@httpx/exception";

// True
isHttpErrorStatusCode(404);
isHttpException(new HttpNotFound());
isHttpClientException(new HttpNotFound());
isHttpServerException(new HttpInternalServerError());

// False
isHttpErrorStatusCode(200);
isHttpClientException(new HttpInternalServerError());
isHttpServerException(new HttpNotFound());
isHttpException(new Error());
```

## Serializer

Exceptions can be (de-)serialized to json or other formats. Use cases varies from
ssr-frameworks (ie: nextjs [getServerSideProps](https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props))
/ loggers (sentry, winston...).

Nested error causes are supported but ignored [if not supported](#about-errorcause) by
the runtime.

Additionally, you can pass any native errors (`Error`, `EvalError`, `RangeError`, `ReferenceError`,
`SyntaxError`, `TypeError`, `URIError`) as well as a custom one (the later will be transformed to the base type Error).

### JSON

```typescript
import { fromJson, toJson } from "@httpx/http-exception/serializer";

const e = new HttpForbidden();

const json = toJson(e); // string
const deserialized = fromJson(json);

// e === deserialized
```

> **Note**
> See also how to integrate with [superjson](https://github.com/blitz-js/superjson#recipes)

### Serializable

Same as JSON but before json.parse/stringify. Allows to use a different encoder.

```typescript
import {
  convertToSerializable,
  createFromSerializable,
} from "@httpx/http-exception/serializer";

const e = new HttpForbidden({
  cause: new Error("Token was revoked"),
});

const serializableObject = convertToSerializable(e);
const deserialized = createFromSerializable(serializableObject);
// e === deserialized
```


## Default messages

Client http status error codes (400...499). Link to

| Status | Class                           |
| ------ | ------------------------------- |
| 400    | HttpBadRequest                  |
| 401    | HttpUnauthorized                |
| 402    | HttpPaymentRequired             |
| 403    | HttpForbidden                   |
| 404    | HttpNotFound                    |
| 405    | HttpMethodNotAllowed            |
| 406    | HttpNotAcceptable               |
| 407    | HttpProxyAuthenticationRequired |
| 408    | HttpRequestTimeout              |
| 409    | HttpConflict                    |
| 410    | HttpGone                        |
| 411    | HttpLengthRequired              |
| 412    | HttpPreConditionFailed          |
| 413    | HttpPayloadTooLarge             |
| 414    | HttpUriTooLong                  |
| 415    | HttpUnsupportedMediaType        |
| 416    | HttpRangeNotSatisfiable         |
| 417    | HttpExpectationFailed           |
| 418    | HttpImATeapot                   |
| 421    | HttpMisdirectedRequest          |
| 422    | HttpUnprocessableEntity         |
| 423    | HttpLocked                      |
| 424    | HttpFailedDependency            |
| 425    | HttpTooEarly                    |
| 426    | HttpUpgradeRequired             |
| 428    | HttpPreconditionFailed          |
| 429    | HttpTooManyRequests             |
| 431    | HttpRequestHeaderFieldsTooLarge |
| 451    | HttpUnavailableForLegalReasons  |

Server http status error code

| Status | Class                             |
| ------ | --------------------------------- |
| 500    | HttpInternalServerError           |
| 501    | HttpNotImplemented                |
| 502    | HttpBadGateway                    |
| 503    | HttpServiceUnavailable            |
| 504    | HttpGatewayTimeout                |
| 505    | HttpVersionNotSupported           |
| 506    | HttpVariantAlsoNegotiates         |
| 507    | HttpInsufficientStorage           |
| 508    | HttpLoopDetected                  |
| 510    | HttpNotExtended                   |
| 511    | HttpNetwordAuthenticationRequired |


### Non-official status codes

While their usage is not recommended, some status codes might be found in the wild (generally server status codes).

```typescript
import { createHttpException, HttpServerException } from '@httpx/exception';

const nonOfficialStatusCodes = [
  [509, 'Might refer to bandwidth limit'],
  [525, 'Might refer to SSL Handshake Failed (ie: cloudflare)'],
  [526, 'Might refer to Invalid SSL Certificate (ie: cloudflare)'],
  ['...', '...'],
];

const e = createHttpException(509, {
  // optional HttpExceptionParams
}); // `e2 instanceof HttpServerException

// alternatively
const alternate = new HttpServerException({
  statusCode: 509,
  // ...(optional HttpExceptionParams)
});
```


## About bundle

### Compatibility

Node 18+ and es2022 compatibility is ensured on the CI.

Browser builds follows the [.browserslistrc](https://github.com/belgattitude/httpx/blob/main/packages/exception/.browserslistrc)
configuration. From the browserslist defaults:
[Chrome 96+, Firefox 90+, Edge 91+, Safari 15+ and Opera 77+](https://browserslist.dev/?q=ZGVmYXVsdHMsY2hyb21lID49IDk2LGZpcmVmb3ggPj0gOTAsZWRnZSA%2BPSA5MSxzYWZhcmkgPj0gMTUsaW9zID49IDE1LG9wZXJhID49IDc3)
are set as minimal supported versions.

For *older* browsers:

- Most frontend frameworks can transpile the library (ie: [nextjs](https://nextjs.org/docs/app/api-reference/next-config-js/transpilePackages)...)
- You might want to add the [error-cause-polyfill](https://github.com/ehmicky/error-cause-polyfill) to support
nested errors (if not present they are simply discarded - no runtime errors).


### Bundle size

Code and bundler have been tuned to target a minimal compressed footprint
for the browser. In typical usage the bundle size will vary between 450b to 750b compressed
(including default messages for the 43 status codes).

ESM individual imports are tracked by a
[size-limit configuration](../.size-limit.cjshttps://github.com/belgattitude/httpx/blob/main/packages/dsn-parser/.size-limit.cjs).

| Scenario                                         | Size (compressed) |
|--------------------------------------------------|------------------:|
| Import generic exception (`HttpClientException`) |            ~ 370b |
| Import 1 client exception                        |            ~ 400b |
| Import 2 client exceptions                       |            ~ 415b |
| Import 6 client exceptions                       |            ~ 430b |
| Import 1 client + 1 server exceptions            |            ~ 415b |
| Import `createHttpException` (all 43 exceptions) |            ~ 690b |
| Import `fromJson` (incl createHttpException)     |           ~ 1100b |
| All exceptions + typeguards + serializer         |           ~ 1500b |

> For CJS usage (not recommended) track the size on [bundlephobia](https://bundlephobia.com/package/@httpx/exception@latest).

### Packaging

This library offers a dual cjs/esm bundle. The (optional) serializer code has been tuned to
avoid issues with [dual package hazards](https://nodejs.org/api/packages.html#dual-package-hazard).

The export fields and the builds are checked on the CI with [are-the-types-wrong](https://arethetypeswrong.github.io/).

> PS: Plans to remove cjs support might land in a next major version.


### Typescript

This library targets typescript 5+ with descriptions (see
[the generated api docs](https://github.com/belgattitude/httpx/tree/main/packages/exception/docs/api)).

